{% extends "base.html" %}

{% block title %}Admin Panel - TimeBank{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="hero-title"><i class="bi bi-shield-lock"></i> Admin Panel</h1>
        <p class="lead text-secondary">Manage users, services, and transactions</p>
    </div>

    <!-- Statistics -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-people" style="font-size: 2rem; color: var(--primary);"></i>
                <div class="stat-value">{{ users|length }}</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-arrow-left-right" style="font-size: 2rem; color: var(--secondary);"></i>
                <div class="stat-value">{{ transactions|length }}</div>
                <div class="stat-label">Transactions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-briefcase" style="font-size: 2rem; color: var(--accent);"></i>
                <div class="stat-value">{{ services|length }}</div>
                <div class="stat-label">Services</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <i class="bi bi-coin" style="font-size: 2rem; color: var(--success);"></i>
                <div class="stat-value">{{ "%.0f"|format(users|sum(attribute='token_balance')) }}</div>
                <div class="stat-label">Total Tokens</div>
            </div>
        </div>
    </div>

    <!-- Users Management -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <h3><i class="bi bi-people"></i> User Management</h3>
                <hr style="border-color: rgba(0, 212, 255, 0.2);">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Earned</th>
                                <th>Spent</th>
                                <th>Reputation</th>
                                <th>Admin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_admin %}
                                    <span class="badge badge-warning ms-1">Admin</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.email }}</td>
                                <td><span style="color: var(--primary);">{{ "%.1f"|format(user.token_balance) }}</span></td>
                                <td><span style="color: var(--success);">{{ "%.1f"|format(user.hours_earned) }}</span></td>
                                <td><span style="color: var(--accent);">{{ "%.1f"|format(user.hours_spent) }}</span></td>
                                <td>{{ "%.1f"|format(user.reputation_score) }}</td>
                                <td>
                                    {% if user.is_admin %}
                                    <i class="bi bi-check-circle" style="color: var(--success);"></i>
                                    {% else %}
                                    <i class="bi bi-x-circle" style="color: var(--text-secondary);"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not user.is_admin %}
                                    <a href="{{ url_for('make_admin', user_id=user.id) }}" 
                                       class="btn btn-sm btn-outline-primary"
                                       onclick="return confirm('Make {{ user.username }} an admin?');">
                                        <i class="bi bi-shield-plus"></i> Make Admin
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <h3><i class="bi bi-clock-history"></i> Recent Transactions</h3>
                <hr style="border-color: rgba(0, 212, 255, 0.2);">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in transactions %}
                            <tr>
                                <td>{{ trans.id }}</td>
                                <td>{{ trans.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if trans.from_user %}
                                    {{ trans.from_user.username }}
                                    {% else %}
                                    <span class="text-secondary">System</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trans.to_user %}
                                    {{ trans.to_user.username }}
                                    {% else %}
                                    <span class="text-secondary">System</span>
                                    {% endif %}
                                </td>
                                <td><strong style="color: var(--primary);">{{ trans.amount }}</strong></td>
                                <td>
                                    <span class="badge badge-{% if trans.transaction_type == 'service' %}success{% elif trans.transaction_type == 'bonus' %}info{% else %}warning{% endif %}">
                                        {{ trans.transaction_type }}
                                    </span>
                                </td>
                                <td>{{ trans.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Services Overview -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <h3><i class="bi bi-briefcase"></i> Services Overview</h3>
                <hr style="border-color: rgba(0, 212, 255, 0.2);">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Duration</th>
                                <th>Provider</th>
                                <th>Requester</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in services %}
                            <tr>
                                <td>{{ service.id }}</td>
                                <td>{{ service.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>{{ service.title }}</td>
                                <td><span class="badge badge-info">{{ service.category }}</span></td>
                                <td>{{ service.duration }}h</td>
                                <td>
                                    {% if service.provider %}
                                    {{ service.provider.username }}
                                    {% else %}
                                    <span class="text-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if service.requester %}
                                    {{ service.requester.username }}
                                    {% else %}
                                    <span class="text-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{% if service.status == 'completed' %}success{% elif service.status == 'pending' %}warning{% else %}danger{% endif %}">
                                        {{ service.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
